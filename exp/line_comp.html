<html>
  <head>
    <title>Line composite task</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <script src="mmturkey.js"></script>
  </head>
  <body>
  </body>
  <script>


  /* ************************************ */
  /* Define helper functions */
  /* ************************************ */
  var randomDraw = function(lst) {
    var index = Math.floor(Math.random() * (lst.length))
    return lst[index]
  }
  
  var getTarget = function() {
    var stim = ''
    stim = shuffledStims[curr_trial].target
    return '<div class = imageBox><img class = image src = ' + stim + ' </img></div>'
  }

  var getPracticeTarget = function() {
    var stim = ''
    stim = shuffledStims_prac[curr_trial].target
    return '<div class = imageBox><img class = image src = ' + stim + ' </img></div>'
  }

  // Sets mask for the trial
  var getMask = function() {
    var mask = randomDraw(['images/Pmask1.jpg', 'images/Pmask2.jpg', 'images/Pmask3.jpg', 'images/Pmask4.jpg', 'images/Pmask5.jpg'])
    return '<div class = imageBox><img class = image src = ' + mask + ' </img></div>'
  }

  var getProbe = function() {
    var stim = ''
    stim = shuffledStims[curr_trial].probe
    return '<div class = imageBox><img class = image src = ' + stim + ' </img></div>'
  }

  var getPracticeProbe = function() {
    var stim = ''
    stim = shuffledStims_prac[curr_trial].probe
    return '<div class = imageBox><img class = image src = ' + stim + ' </img></div>'
  }

  /* ************************************ */
  /* Define experimental variables */
  /* ************************************ */
  var curr_trial = 0
  var test_length = 3 //CHANGE TO 160
  var practice_length = 3 //CHANGE TO 8

  var base_path = 'images/'
  
  var n_base = 20 
  
  // set up practice images
  var practice_start = 20
  var n_practice_base = 2
  var practice_stims = []
  for (var i = 0; i < n_practice_base; i++) {
    for (var j = 0; j < 8; j++) {
      if (j == 0) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_al_01_01.png'],
          alignment: ['aligned'],
          congruency: ['congruent'],
          type: ['same']
        }
        practice_stims.push(stim)
      } else if (j == 1) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_al_02_02.png'],
          alignment: ['aligned'],
          congruency: ['congruent'],
          type: ['different']
        }
        practice_stims.push(stim)
      } else if(j == 2) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_al_01_02.png'],
          alignment: ['aligned'],
          congruency: ['incongruent'],
          type: ['same']
        }
        practice_stims.push(stim)
      } else if(j == 3) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_al_02_01.png'],
          alignment: ['aligned'],
          congruency: ['incongruent'],
          type: ['different']
        }
        practice_stims.push(stim)
      } else if(j == 4) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_mis_01_01.png'],
          alignment: ['misaligned'],
          congruency: ['congruent'],
          type: ['same']
        }
        practice_stims.push(stim)
      } else if(j == 5) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_mis_02_02.png'],
          alignment: ['misaligned'],
          congruency: ['congruent'],
          type: ['different']
        }
        practice_stims.push(stim)
      } else if(j == 6) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_mis_01_02.png'],
          alignment: ['misaligned'],
          congruency: ['incongruent'],
          type: ['same']
        }
        practice_stims.push(stim)
      } else if(j == 7) {
        var stim = {
          target: [base_path + (i+practice_start+1) + '_target_01_01.png'],
          probe: [base_path + (i+practice_start+1) + '_mis_02_01.png'],
          alignment: ['misaligned'],
          congruency: ['incongruent'],
          type: ['different']
        }
        practice_stims.push(stim)
      }
    } 
  }

  var prac_images = []
  for (var i = 0; i < practice_stims.length; i++) {
    prac_images.push(practice_stims[i].target)
    prac_images.push(practice_stims[i].probe)
  }
  //preload images
  jsPsych.pluginAPI.preloadImages(prac_images)

  var shuffledStims_prac = jsPsych.randomization.repeat(practice_stims, 1);


  // set up experiment images
  var stims = []
  for (var i = 0; i < n_base; i++) {
    for (var j = 0; j < 8; j++) {
      if (j == 0) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_al_01_01.png'],
          alignment: ['aligned'],
          congruency: ['congruent'],
          type: ['same']
        }
        stims.push(stim)
      } else if (j == 1) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_al_02_02.png'],
          alignment: ['aligned'],
          congruency: ['congruent'],
          type: ['different']
        }
        stims.push(stim)
      } else if(j == 2) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_al_01_02.png'],
          alignment: ['aligned'],
          congruency: ['incongruent'],
          type: ['same']
        }
        stims.push(stim)
      } else if(j == 3) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_al_02_01.png'],
          alignment: ['aligned'],
          congruency: ['incongruent'],
          type: ['different']
        }
        stims.push(stim)
      } else if(j == 4) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_mis_01_01.png'],
          alignment: ['misaligned'],
          congruency: ['congruent'],
          type: ['same']
        }
        stims.push(stim)
      } else if(j == 5) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_mis_02_02.png'],
          alignment: ['misaligned'],
          congruency: ['congruent'],
          type: ['different']
        }
        stims.push(stim)
      } else if(j == 6) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_mis_01_02.png'],
          alignment: ['misaligned'],
          congruency: ['incongruent'],
          type: ['same']
        }
        stims.push(stim)
      } else if(j == 7) {
        var stim = {
          target: [base_path + (i+1) + '_target_01_01.png'],
          probe: [base_path + (i+1) + '_mis_02_01.png'],
          alignment: ['misaligned'],
          congruency: ['incongruent'],
          type: ['different']
        }
        stims.push(stim)
      }
    } 
  }
    
  var images = []
  for (var i = 0; i < stims.length; i++) {
    images.push(stims[i].target)
    images.push(stims[i].probe)
  }
  //preload images
  jsPsych.pluginAPI.preloadImages(images)

  var shuffledStims = jsPsych.randomization.repeat(stims, 1);


  /* ************************************ */
  /* Set up jsPsych blocks */
  /* ************************************ */
  /* define welcome message block */
  var welcome_block = {
    type: "text",
    text: "Welcome to the experiment. Press any key to begin.",
    data: {
      rt: -1,
    },
  };

  /* define instructions block */
  var main_instructions_block = {
    type: "text",
    text: "<p>In this experiment, a line pattern will appear in the center " +
        "of the screen. Then you will quickly see a jumbled image, " +
        "followed by another line pattern. Finally, a prompt will appear " +
        "asking 'same or different'</p><p>If the <strong>top</strong> half of " +
        "the line pattern was the same as the first line pattern you saw press " +
        "<strong>1</strong>.</p><p> If it's different, press <strong>0</strong>" +
        "<p>We will start with a few practice trials and then go on to the main experiment." +
        " Press any key to begin.</p>",
    timing_post_trial: 2000,
    data: {
      rt: -1,
    },
  };

  /* define instructions block */
  var post_practice_block = {
    type: "text",
    text: "<p>Great. Now we will continue to the main experiment." +
        "<p>Press any key to begin.</p>",
    timing_post_trial: 2000,
    data: {
      rt: -1,
    },
  };

  /* define target presentation */
  var target_block = {
    type: 'single-stim',
    timing_response: 200,
    stimulus: getTarget,
    data: {trial_id: 'target'},
    choices: 'none',
    is_html: true,
  };

  var practice_target_block = {
    type: 'single-stim',
    timing_response: 200,
    stimulus: getPracticeTarget,
    //data: {
    //  trial_id: 'target',
    //},
    choices: 'none',
    is_html: true,
    data: {
      rt: -1,
    },
  };
  
  /* define mask */
  var mask_block = {
    type: 'single-stim',
    timing_response: 400,
    stimulus: getMask,
    data: {trial_id: 'mask'},
    is_html: true,
    choices: 'none',
  };
 
  /* define probe presentation */
  var probe_block = {
    type: 'single-stim',
    timing_response: 200,
    stimulus: getPracticeProbe,
    data: {trial_id: 'probe'},
    is_html: true,
    choices: 'none',
  };

  var practice_probe_block = {
    type: 'single-stim',
    timing_response: 200,
    stimulus: getProbe,
    //data: {trial_id: 'probe'},
    is_html: true,
    choices: 'none',
    data: {
      rt: -1,
    },
  };
 
  /* define response block */
  var response_block = {
    type: 'single-stim',
    stimulus: "<div class = centerbox style = text-align:center><p style = font-size:40px>" +
                "Same or different? </p></div>",
    data: {
      trial_id: 'response',
      response: shuffledStims[curr_trial].type,
      alignment: shuffledStims[curr_trial].alignment,
      congruency: shuffledStims[curr_trial].congruency
    },
    is_html: true,
    choices: [48,49], // Y or N,
    timing_stim: -1,
    timing_post_trial: 1000,


    on_finish: function(data){
      var correct = false;
      if(data.response == 'same' && data.key_press == "49"){
        correct = true;
      } else if(data.response == 'different' && data.key_press == "48"){
        correct = true;
      }
      jsPsych.data.addDataToLastTrial({correct: correct});
      
      curr_trial++
    },
  };

   var practice_response_block = {
    type: 'single-stim',
    stimulus: "<div class = centerbox style = text-align:center><p style = font-size:40px>" +
                "Same or different? </p></div>",
    is_html: true,
    choices: [48,49], // Y or N,
    timing_stim: -1,
    timing_post_trial: 1000,
    data: {
      rt: -1,
    },
  };

  /* define debrief block */
  function getSubjectData() {
    var trials = jsPsych.data.getTrialsOfType('single-stim');
    var response_trials = 0;
    var sum_rt = 0;
    var correct_trial_count = 0;
    var correct_rt_count = 0;
    for (var i = 0; i < trials.length; i++) { //start at 2 to avoid welcome and instructions block
      if(trials[i].rt > -1){
        sum_rt += trials[i].rt;
        correct_rt_count++;
        response_trials++;
        if (trials[i].correct == true) {
          correct_trial_count++;
        }
      }
    }
    return {
      rt: Math.floor(sum_rt / correct_rt_count),
      accuracy: Math.floor(correct_trial_count / response_trials * 100)
    }
  }

  var debrief_block = {
    type: "text",
    text: function() {
      var subject_data = getSubjectData();
      return "<p>You responded correctly on "+subject_data.accuracy+"% of "+
      "the trials.</p><p>Your average response time was <strong>" +
      subject_data.rt + "ms</strong>. Press any key to complete the "+
      "experiment. Thank you!</p>";
    }
  };

  /* create experiment timeline array */
  var timeline = [];
  timeline.push(welcome_block);
  timeline.push(main_instructions_block);
  for (var i = 0; i < practice_length; i++) {
    timeline.push(practice_target_block)
    timeline.push(mask_block)
    timeline.push(practice_probe_block);
    timeline.push(practice_response_block);
  }
  timeline.push(post_practice_block);
  for (var i = 0; i < test_length; i++) {
    timeline.push(target_block)
    timeline.push(mask_block)
    timeline.push(probe_block);
    timeline.push(response_block);
  }
  timeline.push(debrief_block); //need to fix accuracy and rt calc issues

  /* start the experiment */
  jsPsych.init({
    timeline: timeline,
    //fullscreen: true,
    on_finish: function() {
      opener.turk.submit(jsPsych.data.getData())
    }
  });

</script>
</html>

